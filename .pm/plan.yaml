version: 1
spec_hash: "tla-readme-2025-10-03-v1"

milestones:
  - id: M4
    name: "阶段 4：前端体验收敛"
    tasks: [T-0401, T-0402, T-0403, T-0404, T-0405, T-0406]
  - id: M5
    name: "阶段 5：联调与上线准备"
    tasks: [T-0501, T-0502, T-0503, T-0504, T-0505, T-0506, T-0507]
  - id: M9
    name: "维护与质量栅栏（可并行）"
    tasks: [T-0901, T-0902, T-0903]

# 约定的 CI 检查名称（建议后续把你的 workflow job 名称对齐为同名）：
# - build-dotnet     : dotnet build + 还原
# - test-dotnet      : dotnet test
# - test-node        : npm ci && npm test（前端视图模型/JS测试）
# - lint             : 统一代码风格（.editorconfig + eslint/prettier）
# - pack             : 打包/发布预检（仅 M5 使用）
# 如果你现在还没这些 workflow，DoD 里列着也没关系，等你加上 CI 后自动生效。

tasks:

  # ----------------------
  # 阶段 4：前端体验收敛
  # ----------------------

  - id: T-0401
    title: "仪表盘设置页：表单校验与错误提示"
    depends_on: []
    scope:
      allow_paths:
        - "src/webapp/**"
        - "tests/**/dashboardViewModel.test.js"
      deny_paths: ["src/TlaPlugin/**"]     # 不动后端
      max_files_changed: 12
      max_lines_changed: 400
    dod:
      checks: ["build-dotnet", "test-node", "lint"]
      must_add_tests: true
      require_pr_size: "S|M"
    prompt: |
      在 src/webapp 中完善“设置页”表单的必填校验、格式校验与错误提示（沿用现有 i18n）。
      仅改动前端与其测试；新增/修复 dashboardViewModel.test.js 相关用例。
      不修改后端 API；不引入新依赖；不调整路由结构。

  - id: T-0402
    title: "仪表盘：状态轮询与手动刷新"
    depends_on: [T-0401]
    scope:
      allow_paths: ["src/webapp/**", "tests/**/dashboardViewModel.test.js"]
      max_files_changed: 10
      max_lines_changed: 300
    dod:
      checks: ["build-dotnet", "test-node", "lint"]
      must_add_tests: true
    prompt: |
      为 /api/status 与 /api/roadmap 增加安全的客户端轮询（例如 15s/30s）与“刷新”按钮。
      轮询失败应退回上次成功数据并在 UI 显示轻提示；添加对应单测覆盖刷新逻辑。

  - id: T-0403
    title: "前端 i18n 收敛：日文默认+中文覆盖"
    depends_on: [T-0401]
    scope:
      allow_paths: ["src/webapp/**", "src/TlaPlugin/Services/LocalizationCatalogService.cs", "tests/**"]
      max_files_changed: 20
      max_lines_changed: 400
    dod:
      checks: ["build-dotnet", "test-node", "lint"]
      require_pr_size: "S|M"
    prompt: |
      统一前端文案读取逻辑，默认日文，提供中文覆盖；不得引入第三语言。
      对齐 LocalizationCatalogService 的键名，前后端共用同一 key 集。
      更新前端使用处与必要的测试，避免魔法字符串。

  - id: T-0404
    title: "仪表盘：UsageMetrics 折线/柱状卡片"
    depends_on: [T-0402]
    scope:
      allow_paths: ["src/webapp/**", "tests/**/dashboardViewModel.test.js"]
      max_files_changed: 16
      max_lines_changed: 450
    dod:
      checks: ["build-dotnet", "test-node", "lint"]
      must_add_tests: true
    prompt: |
      从 /api/metrics 读取数据，渲染调用量、成本、延迟与失败原因分布。
      UI 仅用原生或轻量图表实现（不新增重量依赖）；提供空数据与错误场景的回退显示。

  - id: T-0405
    title: "前端无网络回退与离线预览"
    depends_on: [T-0402]
    scope:
      allow_paths: ["src/webapp/**", "tests/**"]
      max_files_changed: 12
      max_lines_changed: 300
    dod:
      checks: ["build-dotnet", "test-node", "lint"]
    prompt: |
      无网络/接口 5xx 时，前端回退到本地样例数据（现有样例可复用），标识“离线”状态。
      不得写入 IndexedDB/LocalStorage，纯前端内存回退即可；补充对应测试。

  - id: T-0406
    title: "前端可访问性（a11y）与键盘可用性"
    depends_on: [T-0403]
    scope:
      allow_paths: ["src/webapp/**"]
      max_files_changed: 10
      max_lines_changed: 250
    dod:
      checks: ["lint", "test-node"]
    prompt: |
      为关键交互元素补充 aria-* 属性、标签关联与键盘导航；不改变视觉样式。
      加入基本 a11y 快照测试或 DOM 属性断言。

  # ----------------------
  # 阶段 5：联调与上线准备
  # ----------------------

  - id: T-0501
    title: "模型提供方切换：Mock → 可配置 Provider 预热"
    depends_on: [T-0404]
    scope:
      allow_paths: ["src/TlaPlugin/Providers/**", "src/TlaPlugin/Services/ModelProviderFactory.cs", "tests/TlaPlugin.Tests/**"]
      max_files_changed: 18
      max_lines_changed: 420
    dod:
      checks: ["build-dotnet", "test-dotnet", "lint"]
      must_add_tests: true
    prompt: |
      保留 MockModelProvider 同时完善 ConfigurableChatModelProvider 的参数校验与错误回退路径。
      单测覆盖工厂选择与异常回退；不接入真实密钥，仅打通配置面。

  - id: T-0502
    title: "KeyVaultSecretResolver：密钥映射与 TTL 缓存收敛"
    depends_on: [T-0501]
    scope:
      allow_paths: ["src/TlaPlugin/Services/KeyVaultSecretResolver.cs", "tests/TlaPlugin.Tests/**"]
      max_files_changed: 8
      max_lines_changed: 220
    dod:
      checks: ["build-dotnet", "test-dotnet", "lint"]
      must_add_tests: true
    prompt: |
      完成密钥映射表与 TTL 缓存刷新逻辑的边界测试，清理 TODO；不接公共云，仅模拟接口与缓存策略。

  - id: T-0503
    title: "TokenBroker：OBO 令牌交换与缓存边界"
    depends_on: [T-0502]
    scope:
      allow_paths: ["src/TlaPlugin/Services/TokenBroker.cs", "tests/TlaPlugin.Tests/**"]
      max_files_changed: 10
      max_lines_changed: 300
    dod:
      checks: ["build-dotnet", "test-dotnet", "lint"]
      must_add_tests: true
    prompt: |
      强化 OBO 令牌生成/刷新/提前过期缓存逻辑的单测，补足缺失场景（缺用户、受众不符、过期刷新）。

  - id: T-0504
    title: "TranslationRouter：真实配置下的回退与审计对齐"
    depends_on: [T-0501, T-0502, T-0503]
    scope:
      allow_paths: ["src/TlaPlugin/Services/TranslationRouter.cs", "src/TlaPlugin/Services/AuditLogger.cs", "tests/TlaPlugin.Tests/**"]
      max_files_changed: 16
      max_lines_changed: 420
    dod:
      checks: ["build-dotnet", "test-dotnet", "lint"]
      must_add_tests: true
    prompt: |
      在可配置 Provider 前提下，对失败提供方自动回退并写入审计（含令牌受众信息）。
      单测覆盖“首选失败→回退成功”“预算不足”“认证失败”等路径。

  - id: T-0505
    title: "SmokeTests：Stage5 集成冒烟脚本补齐"
    depends_on: [T-0504]
    scope:
      allow_paths: ["scripts/SmokeTests/**", "docs/stage5-integration-runbook.md"]
      max_files_changed: 20
      max_lines_changed: 500
    dod:
      checks: ["build-dotnet", "test-dotnet", "lint"]
    prompt: |
      完成 scripts/SmokeTests/Stage5SmokeTests 的 `secrets` 与 `reply` 两个命令流程文档化；
      确保输出与 /api/metrics、/api/audit 数据结构一致；补 Runbook 示例。

  - id: T-0506
    title: "CI 栅栏：Dotnet + Node 双流水线与 Auto-merge 条件"
    depends_on: [T-0505]
    scope:
      allow_paths: [".github/workflows/**"]
      max_files_changed: 8
      max_lines_changed: 260
    dod:
      checks: ["build-dotnet", "test-dotnet", "test-node", "lint"]
    prompt: |
      新增/完善 CI：
        - build-dotnet: dotnet restore+build；test-dotnet: dotnet test（生成 trx/coverage）
        - test-node: npm ci + npm test
        - lint: dotnet format / eslint
      把这几个 job 名称与 DoD 对齐；把 main 分支保护策略配置为必须通过这些检查才允许自动合并。

  - id: T-0507
    title: "发布前封板：版本号、变更日志与打包校验"
    depends_on: [T-0506]
    scope:
      allow_paths: ["docs/**", "src/**", ".github/workflows/**"]
      max_files_changed: 10
      max_lines_changed: 300
    dod:
      checks: ["build-dotnet", "test-dotnet", "test-node", "lint", "pack"]
      require_pr_size: "S"
    prompt: |
      统一版本号/变更日志（CHANGELOG.md），新增 pack 预检（仅打包验证，不发布）。
      确保 README 运行/测试说明与现状一致。

  # ----------------------
  # 质量与维护（可穿插执行）
  # ----------------------

  - id: T-0901
    title: "LocalizationCatalogService 键名清点与死键清理"
    depends_on: []
    scope:
      allow_paths: ["src/TlaPlugin/Services/LocalizationCatalogService.cs", "src/webapp/**", "tests/**"]
      max_files_changed: 14
      max_lines_changed: 320
    dod:
      checks: ["build-dotnet", "test-node", "lint"]
    prompt: |
      清理未被使用的 i18n 键名；为新增/修改的键补测试（前端或后端）。

  - id: T-0902
    title: "TranslationThrottle/Cache 配置曝光与文档更新"
    depends_on: []
    scope:
      allow_paths: ["src/TlaPlugin/Services/TranslationThrottle.cs", "src/TlaPlugin/Services/TranslationCache.cs", "docs/**", "tests/**"]
      max_files_changed: 16
      max_lines_changed: 420
    dod:
      checks: ["build-dotnet", "test-dotnet", "lint"]
    prompt: |
      把速率与缓存关键参数通过配置暴露（默认值不变），补充 docs，单测覆盖参数边界。

  - id: T-0903
    title: "消息扩展异常/预算/速率提示的 UI 一致性"
    depends_on: []
    scope:
      allow_paths: ["src/TlaPlugin/Teams/MessageExtensionHandler.cs", "src/webapp/**", "tests/**"]
      max_files_changed: 14
      max_lines_changed: 350
    dod:
      checks: ["build-dotnet", "test-dotnet", "test-node", "lint"]
    prompt: |
      统一 MessageExtensionHandler 与前端对异常/预算/速率的文案与展示；只改 UI 与文案，不改协议。
